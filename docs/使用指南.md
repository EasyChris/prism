# 使用指南

本文档详细介绍 Claude Code Proxy Hub 的使用方法，包括如何配置 Claude Code 代理、三种配置模式、配置管理、日志查看等功能。

---

## 目录

- [如何配置 Claude Code 代理](#如何配置-claude-code-代理)
- [三种配置模式](#三种配置模式)
- [添加配置档案](#添加配置档案)
- [切换配置档案](#切换配置档案)
- [查看实时日志](#查看实时日志)
- [查看统计数据](#查看统计数据)
- [使用场景示例](#使用场景示例)

---

## 如何配置 Claude Code 代理

在开始使用 Claude Code Proxy Hub 之前，需要先配置 Claude Code 使其通过本应用进行代理。我们提供两种配置方式：

### 方法一：一键配置（推荐）

这是最快速的方式，通过命令行直接创建配置文件。

#### macOS / Linux

在终端中执行以下命令：

```bash
mkdir -p ~/.claude && cat > ~/.claude/settings.json << 'EOF'
{
  "env": {
    "ANTHROPIC_AUTH_TOKEN": "your-proxy-api-key",
    "ANTHROPIC_BASE_URL": "http://127.0.0.1:3000",
    "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": 1
  },
  "permissions": {
    "allow": [],
    "deny": []
  }
}
EOF
```

**说明**：
- `your-proxy-api-key` 需要替换为实际的代理服务 API 密钥（在应用仪表盘中可以查看和复制）
- `http://127.0.0.1:3000` 是代理服务的默认地址，如果修改过端口请相应调整

#### Windows (PowerShell)

在 PowerShell 中执行以下命令：

```powershell
$settingsPath = "$env:USERPROFILE\.claude\settings.json"
New-Item -ItemType Directory -Force -Path (Split-Path $settingsPath)
@"
{
  "env": {
    "ANTHROPIC_AUTH_TOKEN": "your-proxy-api-key",
    "ANTHROPIC_BASE_URL": "http://127.0.0.1:3000",
    "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": 1
  },
  "permissions": {
    "allow": [],
    "deny": []
  }
}
"@ | Out-File -FilePath $settingsPath -Encoding UTF8
```

**说明**：
- 同样需要替换 `your-proxy-api-key` 为实际的 API 密钥
- 如果代理地址不是默认的，也需要相应修改

### 方法二：手动配置

如果命令行方式不方便，也可以手动创建配置文件。

#### 步骤 1：找到或创建配置文件

配置文件路径：
- **macOS / Linux**: `~/.claude/settings.json`
- **Windows**: `%USERPROFILE%\.claude\settings.json`

如果 `~/.claude` 目录不存在，需要���创建：
- macOS/Linux 可使用命令：`mkdir -p ~/.claude`
- 或直接在文件管理器中创建

#### 步骤 2：编辑配置文件

创建或编辑 `settings.json` 文件，填写以下内容：

```json
{
  "env": {
    "ANTHROPIC_AUTH_TOKEN": "your-proxy-api-key",
    "ANTHROPIC_BASE_URL": "http://127.0.0.1:3000",
    "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": 1
  },
  "permissions": {
    "allow": [],
    "deny": []
  }
}
```

**关键字段说明**：
- `ANTHROPIC_AUTH_TOKEN`：代理服务的 API 密钥（在应用仪表盘中查看）
- `ANTHROPIC_BASE_URL`：代理服务地址
- `CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC`：禁用非必要流量，提升性能

#### 步骤 3：重启 Claude Code

配置完成后，需要重启 Claude Code 窗口才能使配置生效。

#### 步骤 4：验证配置

配置成功后，在应用的"日志"页面中可以看到 Claude Code 发送的请求记录。

---

## 三种配置模式

Claude Code Proxy Hub 支持三种灵活的配置模式，满足不同使用场景。

### 模式一：官方直连模式

**适用场景**：使用 Anthropic 官方 API，追求最佳性能和稳定性。

**配置示例**：

```yaml
配置名称: Claude 官方
API Base URL: https://api.anthropic.com
API Key: sk-ant-xxxxx
模型映射:
  claude-sonnet-4-5 → claude-sonnet-4-20250514
  claude-opus-4-5 → claude-opus-4-20250514
```

**优势**：
- 直连官方 API，延迟最低
- 支持最新功能和模型
- 稳定性最高

---

### 模式二：聚合平台模式

**适用场景**：使用 OpenRouter 等聚合平台，一次访问多个模型提供商。

**配置示例**：

```yaml
配置名称: OpenRouter
API Base URL: https://openrouter.ai/api/v1
API Key: sk-or-xxxxx
模型映射:
  claude-sonnet-4-5 → anthropic/claude-sonnet-4-5
  claude-opus-4-5 → anthropic/claude-opus-4-5
```

**优势**：
- 一个 API Key 访问多个模型
- 支持不同提供商的模型对比
- 提供缓存和请求队列功能

---

### 模式三：中转代理模式

**适用场景**：使用第三方中转服务或自建代理，降低成本。

**配置示例**：

```yaml
配置名称: 自建代理 / 第三方中转
API Base URL: https://your-proxy.com/v1
API Key: custom-xxxxx
模型映射:
  claude-sonnet-4-5 → claude-3-5-sonnet-20241022
  claude-opus-4-5 → claude-3-opus-20240229
```

**优势**：
- 成本更低
- 支持自定义中转逻辑
- 可配置负载均衡和失败重试

---

## 添加配置档案

### 步骤说明

1. 点击菜单栏图标，选择"打开主界面"

2. 切换到"配置管理"标签页

3. 点击"添加配置"按钮

4. 填写配置信息：

   **基本信息**
   - **名称**：配置档案的显示名称（如 "OpenRouter - Claude"）
   - **API Base URL**：API 提供商的基础 URL
   - **API Key**：你的 API 密钥（会被加密存储）

   **模型映射**
   - **标准模型名称**：Claude Code 使用的模型名（如 `claude-sonnet-4-5`）
   - **映射模型 ID**：���际请求提供商的模型 ID

5. 点击"测试连接"验证配置是否正确

6. 点击"保存"完成配置

### 配置验证

在保存配置前，建议使用"测试连接"功能验证：
- 检查 API Base URL 是否可访问
- 验证 API Key 是否有效
- 确认模型映射是否正确

---

## 切换配置档案

### 快速切换（推荐）

**无需重启 Claude Code 窗口**

1. 点击菜单栏图标
2. 在配置列表中选择要激活的配置
3. 立即生效，继续工作

### 主界面切换

1. 在"配置管理"页面
2. 点击配置卡片上的"激活"按钮
3. 状态实时更新

### 切换生效机制

- 切换配置后，新的请求会立即使用新配置
- 正在进行的请求不会中断
- 无需重启 Claude Code 窗口
- 无需修改任何环境变量

---

## 查看实时日志

### 日志信息

切换到"日志"标签页，查看所有请求记录：

**基础信息**
- 时间戳 - 请求发起时间
- 配置档案 - 使用的配置名称
- 模型 ID - 实际请求的模型

**统计数据**
- Token 消耗 - Input/Output/Total 分类统计
- 请求耗时 - 从发起到响应的完整时间
- HTTP 状态码 - 200/429/500 等状态

### 日志过滤

使用搜索框可以按以下条件过滤：
- 时间范围
- 配置档案
- 模型 ID
- 状态码
- 关键词

### 日志详情

点击日志条目可以查看详细信息：
- 完整请求路径
- 请求头信息
- 响应详情
- 错误信息（如果有）

---

## 查看统计数据

### 仪表盘概览

切换到"仪表盘"标签页，查看统计数据：

**请求统计**
- 总请求次数
- 成功/失败次数
- 成功率

**Token 统计**
- 总 Token 消耗
- Input Token 总计
- Output Token 总计
- 平均每请求 Token 数

**性能统计**
- 平均响应时间
- 最快/最慢响应时间
- P50/P95/P99 响应时间

**成本估算**
- 总成本估算
- 按配置分类成本
- 按模型分类成本

### 数据范围

统计数据支持按以下范围查看：
- 今天
- 最近 7 天
- 最近 30 天
- 全部时间
- 自定义范围

---

## 使用场景示例

### 场景一：工作与个人账号分离

**需求**：工作时使用公司提供的 OpenRouter 账号，个人使用 Anthropic 官方账号。

**配置方案**：

1. 添加配置 A："工作 - OpenRouter"
2. 添加配置 B："个人 - Claude 官方"
3. 工作时激活配置 A，个人时间激活配置 B
4. 无需重启 Claude Code，一键切换

### 场景二：成本优化与性能平衡

**需求**：普通任务使用低成本代理，重要任务使用官方 API 确保质量。

**配置方案**：

1. 添加配置 A："低成本代理" - 第三方中转
2. 添加配置 B："官方 API" - Anthropic 官方
3. 普通开发使用配置 A
4. 重要任务切换到配置 B
5. 通过日志查看对比效果

### 场景三：多模型测试对比

**需求**：测试不同提供商的同一模型性能差异。

**配置方案**：

1. 添加多个配置，指向不同提供商
2. 使用相同的模型映射名称
3. 快速切换不同配置进行测试
4. 通过日志对比响应时间和 Token 消耗

---

## 高级技巧

### 批量导入配置

如果已有多个配置，可以通过编辑数据库批量导入（需手动操作 SQLite）。

### 配置备份

定期备份 `~/Library/Application Support/com.prism.app/database.db` 文件。

### 日志导出

支持将日志导出为 CSV/JSON 格式（开发中）。

---

## 故障排查

### 配置连接失败

1. 检查网络连接
2. 验证 API Base URL 是否正确
3. 确认 API Key 是否有效
4. 查看日志中的错误信息

### 切换配置不生效

1. 确认配置已激活（菜单栏显示对勾）
2. 重启 Claude Code 窗口
3. 检查环境变量是否指向 localhost:3000

### 日志不显示

1. 确认已完成至少一次请求
2. 检查日志过滤条件
3. 刷新日志页面

---

更多问题请参考 [常见问题](常见问题.md) 文档。
