# 技术架构

本文档详细介绍 Claude Code Proxy Hub 的技术栈、架构设计和核心模块实现。

---

## 目录

- [技术栈](#技术栈)
- [架构设计](#架构设计)
- [核心模块](#核心模块)
- [数据模型](#数据模型)
- [代理服务原理](#代理服务原理)
- [安全机制](#安全机制)

---

## 技术栈

### 后端（Rust + Tauri v2）

**核心框架**
- **Tauri v2** - 轻量级桌面应用框架，提供 Rust 后端和 Web 前端的桥接
- **Tokio** - 异步运行时，支持高并发处理

**HTTP 服务**
- **Axum** - 异步 HTTP 服务器框架，用于本地代理服务
- **Reqwest** - HTTP 客户端，用于转发请求到上游 API

**数据存储**
- **SQLite** - 嵌入式数据库，存储配置、日志等数据
- **SeaORM** (可选) - ORM 框架，简化数据库操作

**安全**
- **AES-256-GCM** - API Key 加密存储
- **Ring** 或 **RustCrypto** - 加密算法库

### 前端

**核心框架**
- **React 18** - UI 框架
- **TypeScript** - 类型安全

**样式**
- **Tailwind CSS v4** - 原子化 CSS 框架
- **CSS Modules** - 组件级样式隔离

**构建工具**
- **Vite** - 快速构建工具
- **esbuild** - 底层打包器（Vite 内置）

---

## 架构设计

### 系统架构图

```
┌─────────────┐
│ Claude Code │
└──────┬──────┘
       │ HTTP Request
       ↓ (localhost:15288)
┌─────────────────────────────┐
│   Claude Code Proxy Hub     │
│  ┌───────────────────────┐  │
│  │  动态路由引擎         │  │
│  │  - 模型映射           │  │
│  │  - 配置切换           │  │
│  │  - 请求转发           │  │
│  └───────────────────────┘  │
│  ┌───────────────────────┐  │
│  │  审计日志系统         │  │
│  │  - Token 统计         │  │
│  │  - 耗时监控           │  │
│  │  - 路由追踪           │  │
│  └───────────────────────┘  │
└───────────┬─────────────────┘
            │
    ┌───────┼───────┐
    ↓       ↓       ↓
┌─────┐ ┌─────┐ ┌─────┐
│官方 │ │Open │ │代理 │
│ API │ │Router│ │服务 │
└─────┘ └─────┘ └─────┘
```

### 分层架构

**应用层（Application Layer）**
- Tauri Commands - 前后端通信接口
- 菜单栏集成 - 系统托盘和快捷操作

**业务层（Business Layer）**
- 配置管理 - Profile CRUD 操作
- 路由引擎 - 模型映射和请求转发
- 审计系统 - 日志记录和统计分析

**数据层（Data Layer）**
- SQLite - 持久化存储
- 加密模块 - 敏感信息保护

**传输层（Transport Layer）**
- Axum Server - 本地 HTTP 服务
- Reqwest Client - 上游请求转发

---

## 核心模块

### 1. 配置管理模块

**职责**：管理多个 API 提供商配置

**核心功能**：
- 创建/读取/更新/删除配置
- 加密存储 API Key
- 激活配置切换
- 配置验证测试

**数据结构**：
```rust
struct Profile {
    id: String,
    name: String,
    api_base_url: String,
    api_key_encrypted: String,
    model_mappings: HashMap<String, String>, // 标准名 -> 实际 ID
    is_active: bool,
    created_at: DateTime,
    updated_at: DateTime,
}
```

### 2. 路由引擎模块

**职责**：处理请求转发和模型映射

**核心功能**：
- 接收 Claude Code 的请求
- 模型 ID 映射转换
- 替换 API Key
- 转发到上游 API
- SSE 流式响应透传
- 错误处理和重试

**工作流程**：
```
1. 接收请求 (localhost:15288)
2. 读取当前激活配置
3. 提取请求中的模型 ID
4. 查找模型映射表
5. 替换为实际模型 ID
6. 替换 API Key
7. 转发到上游 API
8. 透传响应（支持 SSE 流式）
9. 记录日志到审计系统
```

### 3. 审计日志模块

**职责**：记录和分析请求日志

**核心功能**：
- 记录每个请求的完整信息
- Token 统计（Input/Output/Total）
- 请求耗时计算
- 路由去向追踪
- 统计数据汇总

**数据结构**：
```rust
struct RequestLog {
    id: String,
    profile_id: String,
    model_requested: String,    // Claude Code 请求的模型
    model_actual: String,       // 实际转发的模型
    provider: String,           // 提供商标识
    input_tokens: i32,
    output_tokens: i32,
    total_tokens: i32,
    duration_ms: i32,
    status_code: u16,
    created_at: DateTime,
}
```

### 4. 加密安全模块

**职责**：保护敏感信息

**核心功能**：
- API Key 加密存储
- 运行时解密
- 密钥派生（基于系统信息）

**加密方案**：
- 算法：AES-256-GCM
- 密钥派生：PBKDF2 或系统 Keychain
- 存储格式：Base64 编码的密文

---

## 数据模型

### 数据库表结构

**profiles 表**
```sql
CREATE TABLE profiles (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    api_base_url TEXT NOT NULL,
    api_key_encrypted TEXT NOT NULL,
    is_active BOOLEAN DEFAULT 0,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

**model_mappings 表**
```sql
CREATE TABLE model_mappings (
    id TEXT PRIMARY KEY,
    profile_id TEXT NOT NULL,
    standard_name TEXT NOT NULL,  -- claude-sonnet-4-5
    mapped_id TEXT NOT NULL,      -- anthropic/claude-sonnet-4-5
    FOREIGN KEY (profile_id) REFERENCES profiles(id)
);
```

**request_logs 表**
```sql
CREATE TABLE request_logs (
    id TEXT PRIMARY KEY,
    profile_id TEXT NOT NULL,
    model_requested TEXT NOT NULL,
    model_actual TEXT NOT NULL,
    provider TEXT NOT NULL,
    input_tokens INTEGER DEFAULT 0,
    output_tokens INTEGER DEFAULT 0,
    cache_read_tokens INTEGER DEFAULT 0,
    cache_write_tokens INTEGER DEFAULT 0,
    duration_ms INTEGER NOT NULL,
    status_code INTEGER NOT NULL,
    created_at TEXT NOT NULL,
    FOREIGN KEY (profile_id) REFERENCES profiles(id)
);
```

---

## 代理服务原理

### 请求转发流程

**1. 请求拦截**
```rust
// Axum 路由处理器
async fn proxy_handler(
    req: Request,
    state: AppState,
) -> Result<Response, Error> {
    // 提取请求信息
    let method = req.method().clone();
    let uri = req.uri().clone();
    let headers = req.headers().clone();

    // 读取请求体
    let body = req.body_mut();
    // ...
}
```

**2. 模型映射**
```rust
// 解析请求体，提取模型
let request_body: AnthropicRequest = serde_json::from_slice(&body)?;

// 查找映射
let active_profile = state.get_active_profile()?;
let mapped_model = active_profile
    .model_mappings
    .get(&request_body.model)
    .unwrap_or(&request_body.model);

// 替换模型
request_body.model = mapped_model.clone();
```

**3. 请求转发**
```rust
// 构建上游请求
let upstream_url = format!("{}/v1/messages", active_profile.api_base_url);

let client = reqwest::Client::new();
let response = client
    .post(&upstream_url)
    .header("x-api-key", &active_profile.api_key)
    .header("anthropic-version", "2023-06-01")
    .json(&request_body)
    .send()
    .await?;
```

**4. 响应处理**
```rust
// 记录日志
log_request(&state, &request_body, &response).await?;

// 返回响应
Ok(response.into_response())
```

### SSE 流式响应

对于流式请求（`stream: true`），需要特殊处理：

```rust
// 检测是否为流式请求
if request_body.stream {
    // 转发 SSE 流
    let mut upstream_stream = response.bytes_stream();

    // 创建转换流
    let transformed_stream = async_stream::stream! {
        while let Some(chunk) = upstream_stream.next().await {
            let chunk = chunk?;
            // 可以在这里处理数据
            yield chunk;
        }
    };

    // 返回 SSE 响应
    return Ok(Response::new(Body::from_stream(transformed_stream)));
}
```

---

## 安全机制

### API Key 加密存储

**加密流程**：
```
1. 生成或获取主密钥（基于系统 Keychain）
2. 使用 AES-256-GCM 加密 API Key
3. 存储 Base64 编码的密文到数据库
```

**解密流程**：
```
1. 从数据库读取密文
2. Base64 解码
3. 使用主密钥解密
4. 在内存中使用（不写入日志）
```

### 敏感信息脱敏

**界面展示**：
```
原始：sk-ant-api03-xxxxx
显示：sk-ant-**** (点击查看)
```

**日志记录**：
```
所有日志中的 API Key 都会被替换为 [REDACTED]
```

### 网络安全

**本地服务**：
- 仅监听 127.0.0.1，不接受外部请求
- 不提供任何远程管理接口

**上游通信**：
- 使用 HTTPS 加密传输
- 支持 HTTP/2 和 HTTP/3
- 不缓存任何敏感数据

---

## 性能优化

### 异步处理

- 使用 Tokio 异步运行时
- 所有 I/O 操作非阻塞
- 支持高并发请求

### 内存管理

- 流式响应处理，不缓存完整响应体
- 及时释放资源
- 使用对象池复用连接

### 数据库优化

- 适当的索引设计
- 批量写入日志
- 定期清理旧日志

---

## 扩展性设计

### 插件系统（未来）

- 支持自定义中间件
- 支持自定义认证方式
- 支持自定义日志格式

### 多平台支持

- 核心逻辑与平台无关
- 使用 Tauri 的平台抽象层
- 未来可支持 Windows/Linux

---

更多技术细节请参考 [开发文档](开发文档.md)。
