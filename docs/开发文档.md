# 开发文档

本文档详细介绍 Claude Code Proxy Hub 的开发环境、项目结构、构建流程和贡献指南。

---

## 目录

- [项目结构](#项目结构)
- [开发环境设置](#开发环境设置)
- [构建和运行](#构建和运行)
- [测试](#测试)
- [代码规范](#代码规范)
- [贡献指南](#贡献指南)

---

## 项目结构

### 目录树

```
prism/
├── src/                      # 前端代码（React + TypeScript）
│   ├── components/           # React 组件
│   │   ├── common/          # 通用组件
│   │   ├── layout/          # 布局组件
│   │   └── features/        # 功能组件
│   ├── pages/               # 页面组件
│   │   ├── Dashboard.tsx    # 仪表盘
│   │   ├── Config.tsx       # 配置管理
│   │   └── Logs.tsx         # 日志查看
│   ├── lib/                 # 工具函数
│   ├── contexts/            # React Context
│   ├── hooks/               # 自定义 Hooks
│   ├── styles/              # 样式文件
│   └── main.tsx             # 入口文件
├── src-tauri/               # Tauri 后端代码（Rust）
│   ├── src/
│   │   ├── main.rs          # 主入口
│   │   ├── commands.rs      # Tauri Commands（前后端通信）
│   │   ├── config/          # 配置管理模块
│   │   │   ├── mod.rs
│   │   │   ├── profile.rs   # 配置档案
│   │   │   └── encryption.rs # 加密解密
│   │   ├── proxy/           # 代理服务模块
│   │   │   ├── mod.rs
│   │   │   ├── server.rs    # HTTP 服务器
│   │   │   └── handler.rs   # 请求处理器
│   │   ├── db/              # 数据库模块
│   │   │   ├── mod.rs
│   │   │   ├── schema.rs    # 数据模型
│   │   │   └── connection.rs # 数据库连接
│   │   └── logger/          # 日志模块
│   │       ├── mod.rs
│   │       └── recorder.rs  # 日志记录器
│   ├── Cargo.toml           # Rust 依赖配置
│   ├── tauri.conf.json      # Tauri 配置
│   └── build.rs             # 构建脚本
├── docs/                    # 项目文档
├── tests/                   # 测试文件
├── package.json             # Node.js 依赖配置
├── vite.config.ts           # Vite 配置
├── tsconfig.json            # TypeScript 配置
└── README.md                # 项目说明
```

### 前端模块划分

**components/common/** - 通用组件
- Button
- Input
- Modal
- Table
- Card

**components/layout/** - 布局组件
- Header
- Sidebar
- Footer

**components/features/** - 功能组件
- ProfileCard
- LogEntry
- StatCard
- ConfigForm

### 后端模块划分

**config/** - 配置管理
- Profile CRUD 操作
- API Key 加密存储
- 配置验证

**proxy/** - 代理服务
- HTTP 服务器（Axum）
- 请求转发逻辑
- 模型映射

**db/** - 数据库
- SQLite 连接管理
- 数据模型定义
- 查询构建

**logger/** - 日志系统
- 请求日志记录
- Token 统计
- 性能监控

---

## 开发环境设置

### 系统要求

**macOS**
- macOS 10.15 (Catalina) 或更高版本
- Xcode Command Line Tools

**其他系统（未来支持）**
- Windows 10 或更高版本
- Linux（主流发行版）

### 必需工具

**Rust 工具链**
```bash
# 安装 Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 验证安装
rustc --version
cargo --version
```

**Node.js 和 pnpm**
```bash
# 安装 Node.js（推荐使用 nvm）
nvm install 20
nvm use 20

# 安装 pnpm
npm install -g pnpm

# 验证安装
node --version
pnpm --version
```

**Tauri CLI**
```bash
# 安装 Tauri CLI
pnpm install -g @tauri-apps/cli

# 验证安装
tauri --version
```

### 可选工具

**数据库工具**
```bash
# SQLite 命令行工具
brew install sqlite3

# 可视化工具（推荐）
# DB Browser for SQLite
# https://sqlitebrowser.org/
```

**代码质量工具**
```bash
# Rust 代码格式化
rustup component add rustfmt

# Rust 代码检查
rustup component add clippy

# TypeScript 格式化
pnpm add -D prettier
```

---

## 构建和运行

### 开发模式

**启动开发服务器**：
```bash
# 安装依赖
pnpm install

# 启动 Tauri 开发模式
pnpm tauri dev
```

这会：
1. 启动 Vite 开发服务器（前端）
2. 编译 Rust 代码（后端）
3. 打开应用窗口
4. 启用热重载（HMR）

**开发模式特性**：
- 前端热重载
- 后端自动重新编译
- 详细的日志输出
- 开发者工具集成

### 生产构建

**构建发布版本**：
```bash
# 构建生产版本
pnpm tauri build

# 构建结果位置
# macOS: src-tauri/target/release/bundle/macos/
```

**构建配置**：
```toml
# src-tauri/tauri.conf.json
{
  "build": {
    "beforeDevCommand": "pnpm dev",
    "beforeBuildCommand": "pnpm build",
    "devUrl": "http://localhost:1420",
    "frontendDist": "../dist"
  }
}
```

### 环境变量

**前端环境变量**（.env）：
```bash
# API 地址（开发模式）
VITE_API_URL=http://localhost:15288

# 日志级别
VITE_LOG_LEVEL=debug
```

**后端环境变量**（通过 tauri.conf.json 配置）：
```rust
// 在代码中读取
const db_path: String = std::env::var("PRISM_DB_PATH")
    .unwrap_or_else(|_| "./prism.db".to_string());
```

---

## 测试

### 前端测试

**单元测试**（Vitest）：
```bash
# 运行测试
pnpm test

# 覆盖率报告
pnpm test:coverage
```

**组件测试**（Testing Library）：
```typescript
// ExampleComponent.test.tsx
import { render, screen } from '@testing-library/react';
import { ExampleComponent } from './ExampleComponent';

test('renders component', () => {
  render(<ExampleComponent />);
  expect(screen.getByText('Hello')).toBeInTheDocument();
});
```

### 后端测试

**单元测试**（Rust 内置）：
```bash
# 运行测试
cargo test

# 运行特定测试
cargo test test_profile_create

# 显示输出
cargo test -- --nocapture
```

**集成测试**：
```rust
// tests/integration_test.rs
#[tokio::test]
async fn test_proxy_flow() {
    // 启动测试服务器
    let app = create_test_app().await;

    // 发送测试请求
    let response = app
        .oneshot(Request::builder()
            .uri("/v1/messages")
            .body(Body::empty())
            .unwrap())
        .await
        .unwrap();

    assert_eq!(response.status(), StatusCode::OK);
}
```

### 端到端测试

**使用 Playwright 或 Cypress**（未来）：
```bash
# 安 Playwright
pnpm add -D @playwright/test

# 运行 E2E 测试
pnpm test:e2e
```

---

## 代码规范

### Rust 代码规范

**格式化**：
```bash
# 格式化所有代码
cargo fmt

# 检查格式
cargo fmt --check
```

**代码检查**（Clippy）：
```bash
# 运行 Clippy
cargo clippy

# 修复建议
cargo clippy --fix
```

**命名规范**：
- 结构体：PascalCase（`ProfileManager`）
- 函数：snake_case（`create_profile`）
- 常量：SCREAMING_SNAKE_CASE（`MAX_RETRIES`）
- 模块：snake_case（`config/mod.rs`）

**注释规范**：
```rust
/// 配置档案管理器
///
/// 负责配置档案的 CRUD 操作和加密存储
pub struct ProfileManager {
    // ...
}

/// 创建新的配置档案
///
/// # 参数
///
/// * `name` - 配置名称
/// * `api_url` - API Base URL
/// * `api_key` - API Key（将被加密存储）
///
/// # 返回
///
/// 返回创建的配置档案 ID
///
/// # 示例
///
/// ```
/// let id = create_profile("My Config", "https://api.example.com", "key").await?;
/// ```
pub async fn create_profile(
    name: String,
    api_url: String,
    api_key: String,
) -> Result<String, Error> {
    // ...
}
```

### TypeScript 代码规范

**格式化**（Prettier）：
```bash
# 格式化所有代码
pnpm format

# 检查格式
pnpm format:check
```

**代码检查**（ESLint）：
```bash
# 运行 ESLint
pnpm lint

# 自动修复
pnpm lint:fix
```

**命名规范**：
- 组件：PascalCase（`Dashboard.tsx`）
- 函数/变量：camelCase（`getUserById`）
- 常量：UPPER_SNAKE_CASE（`MAX_RETRIES`）
- 类型/接口：PascalCase（`UserProfile`）

**注释规范**：
```typescript
/**
 * 用户配置档案
 */
export interface UserProfile {
  /** 配置 ID */
  id: string;
  /** 配置名称 */
  name: string;
  /** API Base URL */
  apiBaseUrl: string;
}

/**
 * 获取用户配置
 * @param id - 配置 ID
 * @returns 用户配置对象
 */
export async function getUserProfile(
  id: string
): Promise<UserProfile | null> {
  // ...
}
```

### Git 提交规范

**提交消息格式**：
```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型（type）**：
- `feat` - 新功能
- `fix` - 修复 Bug
- `docs` - 文档更新
- `style` - 代码格式（不影响功能）
- `refactor` - 重构
- `test` - 测试相关
- `chore` - 构建过程或辅助工具

**示例**：
```
feat(config): 支持模型映射功能

- 添加模型映射表管理
- 实现自动模型 ID 转换
- 支持批量导入映射配置

Closes #123
```

---

## 调试技巧

### 前端调试

**React DevTools**：
```bash
# 安装 React DevTools 浏览器扩展
# https://react.dev/tools/
```

**控制台日志**：
```typescript
console.log('Debug info:', data);
console.error('Error:', error);
console.table([array_data]);
```

**性能分析**：
```typescript
// 使用 React Profiler
import { Profiler } from 'react';

<Profiler id="Dashboard" onRender={onRenderCallback}>
  <Dashboard />
</Profiler>
```

### 后端调试

**日志输出**：
```rust
// 使用 log crate
use log::{info, debug, error};

info!("Starting proxy server");
debug!("Request: {:?}", request);
error!("Failed to connect: {}", err);
```

**环境变量控制日志级别**：
```bash
# 设置日志级别
RUST_LOG=debug cargo run

# 只显示特定模块
RUST_LOG=prism::proxy=debug cargo run
```

**LLDB 调试**：
```bash
# 使用 LLDB 调试
rust-lldb target/debug/prism

# 常用命令
(lldb) break set -n main
(lldb) run
(lldb) print variable_name
```

---

## 性能优化

### 前端优化

**代码分割**：
```typescript
// 懒加载页面组件
const Dashboard = lazy(() => import('./pages/Dashboard'));
const Logs = lazy(() => import('./pages/Logs'));

// 使用 Suspense
<Suspense fallback={<Loading />}>
  <Dashboard />
</Suspense>
```

**虚拟列表**：
```typescript
// 使用 react-window 处理大量日志
import { FixedSizeList } from 'react-window';

<FixedSizeList
  height={600}
  itemCount={logs.length}
  itemSize={50}
>
  {({ index, style }) => <LogEntry log={logs[index]} style={style} />}
</FixedSizeList>
```

### 后端优化

**异步处理**：
```rust
// 使用 Tokio 并发处理
use tokio::task::JoinSet;

let mut set = JoinSet::new();
for request in requests {
    set.spawn(async move {
        process_request(request).await
    });
}

while let Some(result) = set.join_next().await {
    // 处理结果
}
```

**连接池**：
```rust
// 使用 reqwest 连接池
let client = reqwest::Client::builder()
    .pool_max_idle_per_host(10)
    .pool_idle_timeout(Duration::from_secs(30))
    .build()?;
```

---

## 贡献指南

### 贡献流程

1. **Fork 仓库**
   ```bash
   # 在 GitHub 上 Fork 项目
   git clone https://github.com/yourusername/prism.git
   ```

2. **创建功能分支**
   ```bash
   git checkout -b feature/amazing-feature
   ```

3. **编写代码**
   - 遵循代���规范
   - 添加测试
   - 更新文档

4. **提交代码**
   ```bash
   git add .
   git commit -m "feat: add amazing feature"
   ```

5. **推送并创建 PR**
   ```bash
   git push origin feature/amazing-feature
   # 在 GitHub 上创建 Pull Request
   ```

### Pull Request 检查清单

- [ ] 代码通过所有测试
- [ ] 代码符合规范（`cargo fmt` 和 `cargo clippy`）
- [ ] 添加必要的注释和文档
- [ ] 更新相关文档（如果有）
- [ ] PR 描述清晰，说明改动内容和原因

### 问题报告

**报告 Bug**：
1. 使用 [GitHub Issues](https://github.com/yourusername/prism/issues)
2. 提供复现步骤
3. 附上错误日志和系统信息

**功能建议**：
1. 在 [GitHub Discussions](https://github.com/yourusername/prism/discussions) 讨论
2. 说明使用场景和需求
3. 提供设计思路（可选）

---

## 相关资源

- [Tauri 官方文档](https://v2.tauri.app/)
- [Rust 官方文档](https://www.rust-lang.org/)
- [React 官方文档](https://react.dev/)
- [Axum 文档](https://docs.rs/axum/)
- [项目 CLAUDE.md](../CLAUDE.md)

---

更多问题请参考 [常见问题](常见问题.md)。
