# 常见问题

本文档汇总了 Claude Code Proxy Hub 的常见问题和故障排查方法。

---

## 目录

- [使用相关](#使用相关)
- [配置相关](#配置相关)
- [性能相关](#性能相关)
- [安全相关](#安全相关)
- [故障排查](#故障排查)

---

## 使用相关

### Q: 为什么需要这个工具？

**A**: 如果你使用 Claude Code 并且遇到以下情况，这个工具可以完美解决：

**痛点一：多供应商管理繁琐**
- 使用多个 API 提供商（官方、OpenRouter、第三方代理）
- 每次切换都需要修改环境变量
- 必须重启 Claude Code 窗口

**痛点二：模型 ID 不统一**
- Anthropic 官方：`claude-sonnet-4-20250514`
- OpenRouter：`anthropic/claude-sonnet-4-5`
- 第三方代理：`claude-3-5-sonnet-20241022`

**痛点三：缺乏审计能力**
- 不知道消耗了多少 Token
- 不清楚请求去了哪个提供商
- 无法统计成本和性能

**Proxy Hub 的解决方案**：
- 菜单栏一键切换，无需重启
- 自动模型映射，透明兼容
- 完整日志记录，精确审计

### Q: 真的无需重启 Claude Code 吗？

**A**: 是的！这是 Proxy Hub 的核心优势：

**工作原理**：
1. Claude Code 始终向 `localhost:3000` 发送请求
2. Proxy Hub 在本地接收请求，根据当前激活配置转发
3. 切换配置只改变转发目标，不影响 Claude Code

**切换流程**：
```
传统方式：
修改 .zshrc → 重启终端 → 重启 Claude Code → 等待初始化
耗时：30+ 秒

Proxy Hub：
点击菜单栏 → 选择配置 → 立即生效
耗时：1 秒
```

### Q: 会影响 Claude Code 的性能吗？

**A**: 不会。代理转发延迟极低：

**性能数据**：
- 平均转发延迟：< 10ms
- 典型请求延迟：API 延迟 + 5-10ms
- 对使用体验完全无感知

**优化措施**：
- 本地处理，无网络跳转
- 异步处理，非阻塞
- 流式响应透传，无缓存
- 连接池复用

### Q: 可以用于其他 AI 工具吗？

**A**: 理论上可以，但有限制：

**支持条件**：
- 工具支持配置自定义 API Base URL
- 兼容 Anthropic API 格式

**测试情况**：
- ✅ Claude Code（完美支持）
- ⚠️ 其他基于 Anthropic API 的工具（可能需要适配）
- ❌ 不兼容 OpenAI 格式的工具

**注意**：本项目专为 Claude Code 优化，其他工具可能需要额外适配。

---

## 配置相关

### Q: 如何选择配置模式？

**A**: 根据需求选择：

**官方直连模式** - 如果：
- 追求最佳性能和稳��性
- 需要最新模型功能
- 成本不是主要考虑

**聚合平台模式** - 如果：
- 希望一个 Key 访问多个模型
- 需要模型对比功能
- 利用平台的缓存和队列

**中转代理模式** - 如果：
- 需要降低成本
- 有自建代理服务
- 需要自定义中转逻辑

### Q: 模型映射如何配置？

**A**: 模型映射解决不同提供商模型 ID 不统一的问题：

**步骤**：
1. 在 Proxy Hub 中添加配置
2. 在"模型映射"部分填写映射关系
3. 左侧填标准名称（Claude Code 使用的）
4. 右侧填实际模型 ID（提供商要求的）

**示例**：
```
标准名称：claude-sonnet-4-5
映射到：anthropic/claude-sonnet-4-5 (OpenRouter)
```

**如何查找提供商的模型 ID**：
- Anthropic 官方：查看 [API 文档](https://docs.anthropic.com/)
- OpenRouter：查看 [models](https://openrouter.ai/models)
- 第三方代理：咨询提供商

### Q: API Key 安全吗？

**A**: 是的，有多层安全保护：

**存储安全**：
- 使用 AES-256-GCM 加密存储
- 密钥基于系统 Keychain 派生
- 数据库文件权限保护

**传输安全**：
- 上游通信使用 HTTPS
- 本地服务仅监听 127.0.0.1
- 不接受外部连接

**显示安全**：
- 界面默认脱敏显示（`sk-ant-****`）
- 点击可查看明文（临时解密）
- 日志中完全隐藏

**最佳实践**：
- 定期更换 API Key
- 不要分享配置文件
- 备份时注意加密

### Q: 支持哪些 API 提供商？

**A**: 理论上支持所有兼容 Anthropic API 格式的提供商：

**已测试**：
- ✅ Anthropic 官方 API
- ✅ OpenRouter

**理论上兼容**：
- ✅ 第三方中转代理（如 API2D 等）
- ✅ 自建代理服务
- ✅ 任何兼容 Anthropic API 格式的服务

**不兼容**：
- ❌ OpenAI 格式 API
- ❌ 自定义格式的 API

**验证方法**：
使用"测试连接"功能验证配置是否正确。

---

## 性能相关

### Q: 内存占用如何？

**A**: 非常低：

**典型占用**：
- 空闲时：~50MB
- 运行时：~100MB
- 大量日志后：~200MB

**优化措施**：
- 流式处理，不缓存响应
- 定期清理旧日志
- 数据库索引优化

### Q: 日志会无限增长吗？

**A**: 不会，有自动清理机制：

**当前策略**：
- 保留最近 30 天的日志
- 超过 10,000 条时自动清理

**未来计划**：
- 可配置保留天数
- 可配置最大条数
- 手动清理功能
- 导出归档功能

### Q: 支持高并发吗？

**A**: 支持：

**并发能力**：
- 使用 Tokio 异步运行时
- 支持同时处理多个请求
- 连接池复用

**测试数据**：
- 单配置：100+ 并发无压力
- 多配置：仅切换配置时微阻塞（< 1ms）

---

## 安全相关

### Q: 会上传数据到云端吗？

**A**: 完全不会：

**数据处理**：
- 所有请求仅转发到配置的 API 提供商
- 不经过任何中间服务器
- 不收集任何使用统计

**网络行为**：
- 仅监听本地 127.0.0.1:3000
- 仅向配置的 API Base URL 发起请求
- 无其他网络连接

**代码开源**：
- 所有代码公开可审查
- 欢迎安全审计

### Q: API Key 如何加密？

**A**: 使用行业标准的加密方案：

**加密流程**：
```
1. 生成主密钥（基于系统 Keychain）
2. 使用 AES-256-GCM 加密 API Key
3. 存储 Base64 编码的密文
```

**解密流程**：
```
1. 从数据库读取密文
2. Base64 解码
3. 使用主密钥解密
4. 在内存中使用
```

**密钥管理**：
- 主密钥存储在系统 Keychain
- 支持 macOS Keychain
- 未来支持其他平台的原生存储

---

## 故障排查

### 问题一：配置连接失败

**症状**：点击"测试连接"显示失败

**可能原因**：
1. 网络连接问题
2. API Base URL 错误
3. API Key 无效
4. 提供商服务不可用

**解决步骤**：
```bash
# 1. 检查网络连接
ping api.anthropic.com

# 2. 验证 API URL
curl https://api.anthropic.com/v1/messages \
  -H "x-api-key: your-key"

# 3. 检查 API Key
# 登录提供商后台确认 Key 是否有效

# 4. 查看日志
# 在 Proxy Hub 日志中查看详细错误信息
```

### 问题二：切换配置不生效

**症状**：切换配置后请求仍然使用旧配置

**可能原因**：
1. Claude Code 环境变量未配置
2. 配置未激活
3. 缓存问题

**解决步骤**：
```bash
# 1. 检查环境变量
echo $ANTHROPIC_API_URL  # 应该显示 http://localhost:3000

# 2. 确认配置激活
# 菜单栏中当前配置应该有勾选标记

# 3. 重启 Claude Code（最后手段）
# 如果仍不生效，尝试重启 Claude Code 窗口
```

### 问题三：日志不显示

**症状**：完成请求后日志面板为空

**可能原因**：
1. 请求未经过 Proxy Hub
2. 日志过滤条件过严
3. 数据库写入失败

**解决步骤**：
```
# 1. 确认请求经过 Proxy Hub
# 检查环境变量是否配置正确

# 2. 重置日志过滤
# 清空搜索框，选择"全部时间"

# 3. 刷新页面
# 重新加载日志面板

# 4. 检查数据库
# 查看是否有数据库错误
```

### 问题四：启动失败

**症状**：应用无法启动

**可能原因**：
1. 数据库文件损坏
2. 端口被占用
3. 权限问题

**解决步骤**：
```bash
# 1. 检查端口占用
lsof -i :3000

# 2. 清理数据库（谨慎操作）
rm ~/Library/Application\ Support/com.prism.app/database.db

# 3. 重新安装应用
# 删除应用，重新安装
```

### 问题五：性能下降

**症状**：响应变慢或卡顿

**可能原因**：
1. 日志过多
2. 网络问题
3. 系统资源不足

**解决步骤**：
```
# 1. 清理旧日志
# 在设置中清理旧日志（未来功能）

# 2. 检查网络
ping api.anthropic.com

# 3. 检查系统资源
# 活动监视器查看 CPU 和内存占用

# 4. 重启应用
# 关闭并重新打开 Proxy Hub
```

---

## 获取帮助

如果以上方法无法解决问题：

**报告 Bug**：
- [GitHub Issues](https://github.com/yourusername/prism/issues)
- 提供详细的错误日志
- 说明系统版本和复现步骤

**功能建议**：
- [GitHub Discussions](https://github.com/yourusername/prism/discussions)
- 说明使用场景和需求

**其他问题**：
- 查阅 [使用指南](使用指南.md)
- 查看 [技术架构](技术架构.md)
- 阅读 [开发文档](开发文档.md)

---

## 更新日志

查看版本历史和更新内容，请参考 [路线图](路线图.md)。
